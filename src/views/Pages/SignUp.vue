<template>
	<div class="login-container">
		<div id="login">
			<img class="logo" src="../../assets/_img/logo/logo-cyan.svg" alt="Shieldmaiden" />
			<h2 class="mt-3">Crea una cuenta</h2>
			<p v-if="error" class="red">
				<i aria-hidden="true" class="fas fa-exclamation-triangle"></i> {{ error }}
			</p>

			<button class="google mt-2" @click="googleSignIn()">Inicia sesi칩n con Google</button>
			<hr />
			<ValidationObserver v-slot="{ handleSubmit, valid }">
				<q-form v-if="!loading" @submit="handleSubmit(signUp)">
					<h4 class="text-center neutral-2">O con un correo y contrase침a</h4>

					<hk-input
						v-model="email"
						autocomplete="username"
						class="email mb-2"
						type="email"
						label="Correo"
						name="Email"
						rules="required|email"
					/>
					<hk-input
						v-model="username"
						type="text"
						class="mb-2"
						label="Usuario"
						name="Username"
						maxlength="20"
						minlength="3"
						rules="required|alpha_num|max:20|min:3|username"
					/>

					<hk-input
						autocomplete="new-password"
						class="mb-2"
						type="password"
						placeholder="Contrase침a"
						v-model="password"
						name="password"
						rules="required"
					/>

					<hk-input
						autocomplete="new-password"
						class="mb-2"
						type="password"
						placeholder="Confirmar contrase침a"
						v-model="confirm_password"
						rules="required|confirmed:password"
						name="Confirm Password"
					/>

					<q-btn
						no-caps
						label="Registrarse"
						class="full-width"
						color="primary"
						type="submit"
						:disabled="!valid"
					/>
				</q-form>
				<hk-loader v-else prefix="Registrarte" noBackground />
			</ValidationObserver>
		</div>
	</div>
</template>

<script>
import { db, firebase, auth } from "src/firebase";
import { mapActions } from "vuex";

export default {
	data: function () {
		return {
			email: undefined,
			password: undefined,
			confirm_password: undefined,
			username: undefined,
			error: undefined,
			loading: false,
		};
	},
	preFetch({ store, redirect }) {
		if (store.getters.user) {
			redirect("/content");
		}
	},
	methods: {
		...mapActions(["reinitialize", "setUser", "setUserInfo"]),
		async createUser(uid) {
			let user = {
				username: this.username,
				email: this.email,
				created: firebase.database.ServerValue.TIMESTAMP,
			};

			await db.ref(`users/${uid}`).update(user);

			//Save searchable results in search_user
			await db.ref(`search_users`).child(uid).set({
				username: this.username.toLowerCase(),
				email: this.email.toLowerCase(),
			});
		},
		signUp: function () {
			this.loading = true;
			auth.createUserWithEmailAndPassword(this.email, this.password).then(
				// eslint-disable-next-line
				async (result) => {
					await this.createUser(result.user.uid);
					await this.setUser(result.user);
					await this.setUserInfo();
					await this.reinitialize();

					this.$gtm.trackEvent({
						event: "sign-up",
						method: "Email and Password",
					});

					this.$router.replace("/content");
				},
				(err) => {
					this.error = err.message;
					this.loading = false;
				}
			);
		},
		googleSignIn() {
			const provider = new firebase.auth.GoogleAuthProvider();

			auth
				.signInWithPopup(provider)
				.then(() => {
					this.$gtm.trackEvent({
						event: "sign-up",
						method: "Google",
					});
					this.$router.replace("/set-username");
				})
				.catch((err) => {
					this.error = err.message;
				});
		},
	},
};
</script>
