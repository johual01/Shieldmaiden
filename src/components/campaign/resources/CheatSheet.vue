<template>
	<div>
		<hk-input v-model="query" :dense="!compendium" label="Search" class="mb-2" clearable>
			<q-icon slot="prepend" name="search" />
		</hk-input>
		<p class="red" v-if="query && !sheet.length">{{ $t('nothing_found') }}</p>
		<q-tabs
			v-if="!query && !isMobile"
			v-model="tab_type"
			:dark="$store.getters.theme === 'dark'"
			inline-label
			outside-arrows
			mobile-arrows
			class="mb-2"
		>
			<q-tab v-for="{ name, label } in types" :name="name" :label="label" :key="name" />
		</q-tabs>

		<q-list :dark="$store.getters.theme === 'dark'" class="accordion">
			<q-expansion-item
				v-for="{ type, name, description, caption, src, url } in sheet"
				:dark="$store.getters.theme === 'dark'"
				switch-toggle-side
				:name="name"
				:key="url"
			>
				<template v-slot:header>
					<q-item-section>
						<router-link v-if="compendium" :to="`/compendium/rules/${url}`" stop.prevent>
							{{ name }}
						</router-link>
						<template v-else>{{ name }}</template>
						<q-item-label caption class="neutral-3">{{ caption }}</q-item-label>
					</q-item-section>
					<q-item-section avatar class="neutral-3">
						{{ types.filter((item) => item.name === type)[0]?.label }}
					</q-item-section>
				</template>

				<div class="accordion-body">
					<hk-markdown-editor :value="description" read-only />
					<span class="neutral-2">{{ src }}</span>
				</div>
			</q-expansion-item>
		</q-list>
	</div>
</template>

<script>
import { rules } from "src/utils/generalConstants";

export default {
	name: "CheatSheet",
	props: {
		compendium: {
			type: Boolean,
			default: false,
		},
	},
	data() {
		return {
			tab_type: undefined,
			query: null,
			types: [
				{
					name: "action",
					label: this.$t('action_capitalized'),
				},
				{
					name: "bonus_action",
					label: this.$t('bonus_action_capitalized'),
				},
				{
					name: "reaction",
					label: this.$t('reaction_capitalized'),
				},
				{
					name: "movement",
					label: this.$t('movement_capitalized'),
				},
				{
					name: "environment",
					label: this.$t('environment_capitalized'),
				},
			],
			cheatSheet: rules,
		};
	},
	mounted() {
		console.log("Mount Cheat Sheet");
	},
	computed: {
		isMobile() {
			// This only works for real mobiles, not for small desktop screens
			return this.$q.platform.is.mobile;
		},
		sheet() {
			if (this.query) {
				return this.cheatSheet.filter(
					({ name, description }) =>
						name.toLowerCase().includes(this.query.toLowerCase()) ||
						description.toLowerCase().includes(this.query.toLowerCase())
				);
			}
			if (this.tab_type) {
				return this.cheatSheet.filter((item) => item.type === this.tab_type);
			}
			return this.cheatSheet;
		},
	},
};
</script>
